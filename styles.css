// Constants
const FIXED_AMOUNT = 70;
const TIP_OPTIONS = [0, 7, 10.5, 14];
const COUNTRIES = [
    'Albania', 'Andorra', 'Armenia', 'Austria', 'Azerbaijan', 'Belarus', 'Belgium',
    'Bosnia and Herzegovina', 'Bulgaria', 'Croatia', 'Cyprus', 'Czech Republic',
    'Denmark', 'Estonia', 'Finland', 'France', 'Georgia', 'Germany', 'Greece',
    'Hungary', 'Iceland', 'Ireland', 'Italy', 'Kazakhstan', 'Kosovo', 'Latvia',
    'Liechtenstein', 'Lithuania', 'Luxembourg', 'Malta', 'Moldova', 'Monaco',
    'Montenegro', 'Netherlands', 'North Macedonia', 'Norway', 'Poland', 'Portugal',
    'Romania', 'Russia', 'San Marino', 'Serbia', 'Slovakia', 'Slovenia', 'Spain',
    'Sweden', 'Switzerland', 'Turkey', 'Ukraine', 'United Kingdom', 'Vatican City'
];

// State
let tours = JSON.parse(localStorage.getItem('tours')) || [];
let selectedPassengers = 1;
let selectedPaymentMethod = 'cash';
let selectedTip = 0;
let customTip = '';
let countryInput = '';

// DOM Elements
const todayToursElement = document.getElementById('today-tours');
const passengerButtons = document.querySelectorAll('.passenger-btn');
const paymentButtons = document.querySelectorAll('.payment-btn');
const tipButtons = document.querySelectorAll('.tip-btn');
const countryInputElement = document.getElementById('country-input');
const suggestionsContainer = document.getElementById('country-suggestions');
const cashTipSection = document.getElementById('cash-tip-section');
const cardTipSection = document.getElementById('card-tip-section');
const customTipInput = document.getElementById('custom-tip-input');
const saveTourButton = document.getElementById('save-tour-btn');
const toursListElement = document.getElementById('tours-list');
const tourTemplate = document.getElementById('tour-template');

// Initialize
function init() {
    updateTodayStats();
    renderToursList();
    setupEventListeners();
}

// Event Listeners
function setupEventListeners() {
    // Passenger buttons
    passengerButtons.forEach(button => {
        button.addEventListener('click', () => {
            passengerButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            selectedPassengers = parseInt(button.dataset.passengers);
        });
    });

    // Payment buttons
    paymentButtons.forEach(button => {
        button.addEventListener('click', () => {
            paymentButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            selectedPaymentMethod = button.dataset.payment;
            
            // Show/hide tip sections
            if (selectedPaymentMethod === 'cash') {
                cashTipSection.classList.remove('hidden');
                cardTipSection.classList.add('hidden');
            } else {
                cashTipSection.classList.add('hidden');
                cardTipSection.classList.remove('hidden');
            }
        });
    });

    // Tip buttons (for card)
    tipButtons.forEach(button => {
        button.addEventListener('click', () => {
            tipButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            selectedTip = parseFloat(button.dataset.tip);
        });
    });

    // Country input with suggestions
    countryInputElement.addEventListener('input', (e) => {
        countryInput = e.target.value;
        showCountrySuggestions(countryInput);
    });

    // Custom tip input
    customTipInput.addEventListener('input', (e) => {
        customTip = e.target.value;
    });

    // Save tour button
    saveTourButton.addEventListener('click', saveTour);

    // Close suggestions when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-container') && !e.target.closest('.suggestions-container')) {
            suggestionsContainer.classList.remove('show');
        }
    });
}

// Country suggestions
function showCountrySuggestions(query) {
    suggestionsContainer.innerHTML = '';
    
    if (!query || query.length < 1) {
        suggestionsContainer.classList.remove('show');
        return;
    }

    const filtered = COUNTRIES.filter(country => 
        country.toLowerCase().includes(query.toLowerCase())
    ).slice(0, 5);

    if (filtered.length === 0) {
        suggestionsContainer.classList.remove('show');
        return;
    }

    filtered.forEach(country => {
        const suggestionItem = document.createElement('div');
        suggestionItem.className = 'suggestion-item';
        suggestionItem.textContent = country;
        suggestionItem.addEventListener('click', () => {
            countryInputElement.value = country;
            countryInput = country;
            suggestionsContainer.classList.remove('show');
        });
        suggestionsContainer.appendChild(suggestionItem);
    });

    suggestionsContainer.classList.add('show');
}

// Save tour
function saveTour() {
    if (!countryInput) {
        alert('Please select a country');
        return;
    }

    const tip = selectedPaymentMethod === 'cash' 
        ? (customTip ? parseFloat(customTip) : 0)
        : selectedTip;

    const tour = {
        id: Date.now(),
        country: countryInput,
        passengers: selectedPassengers,
        paymentMethod: selectedPaymentMethod,
        tip: tip,
        amount: FIXED_AMOUNT,
        timestamp: new Date().toISOString()
    };

    tours.push(tour);
    saveToLocalStorage();
    renderToursList();
    updateTodayStats();
    resetForm();

    // Show success message
    showSuccessMessage();
}

// Reset form
function resetForm() {
    // Reset to default values
    passengerButtons.forEach((btn, index) => {
        if (index === 0) btn.classList.add('active');
        else btn.classList.remove('active');
    });
    selectedPassengers = 1;

    paymentButtons.forEach(btn => {
        if (btn.dataset.payment === 'cash') {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    selectedPaymentMethod = 'cash';

    tipButtons.forEach((btn, index) => {
        if (index === 0) btn.classList.add('active');
        else btn.classList.remove('active');
    });
    selectedTip = 0;

    countryInputElement.value = '';
    countryInput = '';
    suggestionsContainer.classList.remove('show');

    customTipInput.value = '';
    customTip = '';

    // Show cash tip section
    cashTipSection.classList.remove('hidden');
    cardTipSection.classList.add('hidden');
}

// Render tours list
function renderToursList() {
    toursListElement.innerHTML = '';

    // Get today's tours
    const today = new Date().toDateString();
    const todayTours = tours.filter(tour => {
        const tourDate = new Date(tour.timestamp).toDateString();
        return tourDate === today;
    });

    if (todayTours.length === 0) {
        const noToursElement = document.createElement('div');
        noToursElement.className = 'no-tours-text';
        noToursElement.textContent = 'No tours today yet';
        toursListElement.appendChild(noToursElement);
        return;
    }

    // Sort by timestamp (newest first)
    todayTours.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    // Render each tour
    todayTours.forEach(tour => {
        const tourElement = createTourElement(tour);
        toursListElement.appendChild(tourElement);
    });
}

// Create tour element
function createTourElement(tour) {
    const clone = tourTemplate.content.cloneNode(true);
    const tourCard = clone.querySelector('.tour-card');
    
    // Set country and passengers
    const countryElement = tourCard.querySelector('.tour-country');
    countryElement.textContent = `${tour.country} - ${tour.passengers} pax`;
    
    // Set time
    const timeElement = tourCard.querySelector('.tour-time');
    const tourTime = new Date(tour.timestamp);
    timeElement.textContent = tourTime.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    // Set payment method
    const paymentIcon = tourCard.querySelector('.payment-badge i');
    const paymentText = tourCard.querySelector('.payment-text');
    
    if (tour.paymentMethod === 'cash') {
        paymentIcon.className = 'fas fa-money-bill';
        paymentIcon.style.color = '#10B981';
        paymentText.textContent = 'Cash';
    } else {
        paymentIcon.className = 'fas fa-credit-card';
        paymentIcon.style.color = '#3B82F6';
        paymentText.textContent = 'Card';
    }
    
    // Set amounts
    const amountElement = tourCard.querySelector('.amount');
    const tipElement = tourCard.querySelector('.tour-tip');
    const totalElement = tourCard.querySelector('.total');
    
    amountElement.textContent = `${tour.amount.toFixed(2)} €`;
    
    if (tour.tip > 0) {
        tipElement.textContent = `+ ${tour.tip.toFixed(2)} € tip`;
    } else {
        tipElement.textContent = '';
    }
    
    const total = tour.amount + tour.tip;
    totalElement.textContent = `${total.toFixed(2)} €`;
    
    return tourCard;
}

// Update today's stats
function updateTodayStats() {
    const today = new Date().toDateString();
    const todayTours = tours.filter(tour => {
        const tourDate = new Date(tour.timestamp).toDateString();
        return tourDate === today;
    });
    
    todayToursElement.textContent = `${todayTours.length} Tours Completed`;
}

// Save to localStorage
function saveToLocalStorage() {
    localStorage.setItem('tours', JSON.stringify(tours));
}

// Show success message
function showSuccessMessage() {
    const message = document.createElement('div');
    message.className = 'success-message';
    message.textContent = 'Tour saved successfully!';
    message.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #10B981;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
    `;
    
    document.body.appendChild(message);
    
    setTimeout(() => {
        message.style.animation = 'slideOut 0.3s ease-out forwards';
        setTimeout(() => {
            document.body.removeChild(message);
        }, 300);
    }, 3000);
}

// Add CSS for animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    .success-message {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #10B981;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
    }
`;
document.head.appendChild(style);

// Initialize the app
document.addEventListener('DOMContentLoaded', init);
